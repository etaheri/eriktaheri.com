---
import { existsSync } from "node:fs";
import { getCollection, render } from "astro:content";
import Layout from "@layouts/Layout.astro";
import Container from "@components/Container.astro";
import BackToPrev from "@components/BackToPrev.astro";
import FormattedDate from "@components/FormattedDate.astro";
import ListenButton from "@components/ListenButton.astro";
import { readingTimeFromMarkdown } from "@lib/utils";

export async function getStaticPaths() {
  const posts = (await getCollection("writing")).filter(
    (post) => !post.data.draft
  );
  return posts.map((post) => ({
    params: { slug: post.id },
    props: post,
  }));
}

const post = Astro.props;
const { Content } = await render(post);
const readTime = readingTimeFromMarkdown(post.body ?? "");
const audioExists = existsSync(`public/audio/${post.id}.mp3`);
const ogImage = new URL(`/og/writing/${post.id}.png`, Astro.site).href;
---

<Layout title={post.data.title} description={post.data.description} image={ogImage}>
  <main class="flex-1 py-16">
    <Container>
      <div class="animate" style="animation-delay: 0ms;">
        <BackToPrev href="/writing" label="Back to Writing" />
      </div>

      <article class="mt-8">
        <header class="animate mb-10" style="animation-delay: 100ms;">
          <h1 class="text-3xl font-semibold tracking-tight mb-3">
            {post.data.title}
          </h1>
          <div class="flex items-center gap-3 text-sm text-[var(--color-text-muted)]">
            <FormattedDate date={post.data.date} />
            <span>&middot;</span>
            <span>{readTime}</span>
            <span>&middot;</span>
            <ListenButton audioSrc={audioExists ? `/audio/${post.id}.mp3` : undefined} />
          </div>
        </header>

        <div class="animate prose" style="animation-delay: 200ms;">
          <Content />
        </div>
      </article>
    </Container>
  </main>
</Layout>
